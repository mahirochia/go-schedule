name: Documentation

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.go'
      - 'docs/**'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

# ËÆæÁΩÆ GITHUB_TOKEN ÊùÉÈôê‰ª•ÂÖÅËÆ∏ÈÉ®ÁΩ≤Âà∞ GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Âè™ÂÖÅËÆ∏‰∏Ä‰∏™Âπ∂ÂèëÈÉ®ÁΩ≤
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # ÁîüÊàê Swagger API ÊñáÊ°£
  generate-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install swag CLI
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate Swagger docs
        run: swag init -g main.go -o docs/swagger

      - name: Create docs directory structure
        run: |
          mkdir -p docs/api
          cp -r docs/swagger/* docs/api/

      - name: Create index.html for Swagger UI
        run: |
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Go Schedule API ÊñáÊ°£</title>
            <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5/swagger-ui.css">
            <style>
              html { box-sizing: border-box; overflow-y: scroll; }
              *, *:before, *:after { box-sizing: inherit; }
              body { margin: 0; background: #fafafa; }
              .swagger-ui .topbar { display: none; }
              .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                text-align: center;
              }
              .header h1 { margin: 0 0 10px 0; }
              .header p { margin: 0; opacity: 0.9; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>üìÖ Go Schedule API</h1>
              <p>Êó•Á®ãÁÆ°ÁêÜÁ≥ªÁªü API ÊñáÊ°£</p>
            </div>
            <div id="swagger-ui"></div>
            <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js"></script>
            <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-standalone-preset.js"></script>
            <script>
              window.onload = function() {
                window.ui = SwaggerUIBundle({
                  url: "./api/swagger.json",
                  dom_id: '#swagger-ui',
                  deepLinking: true,
                  presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                  ],
                  plugins: [
                    SwaggerUIBundle.plugins.DownloadUrl
                  ],
                  layout: "StandaloneLayout",
                  defaultModelsExpandDepth: 1,
                  defaultModelExpandDepth: 1,
                  docExpansion: 'list',
                  filter: true,
                  showExtensions: true
                });
              };
            </script>
          </body>
          </html>
          EOF

      - name: Upload docs artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs

  # ÈÉ®ÁΩ≤Âà∞ GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: generate-docs
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

