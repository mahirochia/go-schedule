name: Code Review

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Go ä»£ç é™æ€åˆ†æ
  golangci-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m
          # åªæ˜¾ç¤ºæ–°å¢ä»£ç çš„é—®é¢˜ï¼ˆPR æ—¶ï¼‰
          only-new-issues: true

  # Go å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  # å‰ç«¯ä»£ç æ£€æŸ¥
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npx eslint src --ext .vue,.js,.ts --format stylish || true
        continue-on-error: true

  # ä»£ç æ ¼å¼æ£€æŸ¥
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Check Go formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–ï¼š"
            gofmt -l .
            echo ""
            echo "è¯·è¿è¡Œ 'gofmt -w .' ä¿®å¤æ ¼å¼é—®é¢˜"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰ Go æ–‡ä»¶æ ¼å¼æ­£ç¡®"

      - name: Check go mod tidy
        run: |
          go mod tidy
          if ! git diff --quiet go.mod go.sum; then
            echo "go.mod æˆ– go.sum éœ€è¦æ›´æ–°ï¼Œè¯·è¿è¡Œ 'go mod tidy'"
            exit 1
          fi
          echo "âœ… go.mod å’Œ go.sum å·²æ˜¯æœ€æ–°"

  # PR è‡ªåŠ¨è¯„è®ºï¼ˆä»£ç å®¡æŸ¥æ‘˜è¦ï¼‰
  review-summary:
    name: Review Summary
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [golangci-lint, security-scan, format-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate review summary
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const goFiles = files.filter(f => f.filename.endsWith('.go'));
            const vueFiles = files.filter(f => f.filename.endsWith('.vue') || f.filename.endsWith('.js'));
            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);
            
            const summary = `## ğŸ“Š ä»£ç å®¡æŸ¥æ‘˜è¦
            
            | æŒ‡æ ‡ | æ•°å€¼ |
            |------|------|
            | ğŸ“ ä¿®æ”¹æ–‡ä»¶æ•° | ${files.length} |
            | â• æ–°å¢è¡Œæ•° | ${additions} |
            | â– åˆ é™¤è¡Œæ•° | ${deletions} |
            | ğŸ¹ Go æ–‡ä»¶ | ${goFiles.length} |
            | ğŸ’š Vue/JS æ–‡ä»¶ | ${vueFiles.length} |
            
            ### ä¿®æ”¹çš„æ–‡ä»¶
            ${files.map(f => \`- \${f.status === 'added' ? 'ğŸ†•' : f.status === 'removed' ? 'ğŸ—‘ï¸' : 'ğŸ“'} \\\`\${f.filename}\\\`\`).join('\n')}
            
            ---
            âœ… è‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„æ£€æŸ¥ç»“æœã€‚
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

