name: Code Review

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  # Go ä»£ç é™æ€åˆ†æž
  golangci-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    outputs:
      lint-result: ${{ steps.lint.outputs.result }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Run golangci-lint
        id: lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m --out-format=json
          only-new-issues: true
        continue-on-error: true

      - name: Save lint results
        if: always()
        run: |
          golangci-lint run --timeout=5m --out-format=json > lint-results.json 2>&1 || true
          
      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: lint-results.json
          retention-days: 1

  # Go å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Run Gosec Security Scanner
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -no-fail -fmt json -out security-results.json ./... 2>&1 || true

      - name: Upload security results
        uses: actions/upload-artifact@v4
        with:
          name: security-results
          path: security-results.json
          retention-days: 1

      - name: Run Gosec for SARIF
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: results.sarif

  # å‰ç«¯ä»£ç æ£€æŸ¥
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          npx eslint src --ext .vue,.js,.ts --format json > ../eslint-results.json 2>&1 || true
        continue-on-error: true

      - name: Upload ESLint results
        uses: actions/upload-artifact@v4
        with:
          name: eslint-results
          path: eslint-results.json
          retention-days: 1

  # ä»£ç æ ¼å¼æ£€æŸ¥
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Check Go formatting
        id: gofmt
        run: |
          UNFORMATTED=$(gofmt -l . 2>&1 || true)
          if [ -n "$UNFORMATTED" ]; then
            echo "unformatted=$UNFORMATTED" >> $GITHUB_OUTPUT
            echo "éœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶ï¼š"
            echo "$UNFORMATTED"
          fi

      - name: Check go mod tidy
        run: |
          go mod tidy
          if ! git diff --quiet go.mod go.sum; then
            echo "go.mod æˆ– go.sum éœ€è¦æ›´æ–°"
          fi

  # AI ä»£ç å®¡æŸ¥ï¼ˆä½¿ç”¨ DeepSeek API - è¡Œå†…è¯„è®ºï¼‰
  ai-review:
    name: AI Code Review (DeepSeek)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && vars.ENABLE_AI_REVIEW == 'true'
    needs: [golangci-lint, security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # èŽ·å– PR çš„ diffï¼ˆå¸¦æ–‡ä»¶å’Œè¡Œå·ä¿¡æ¯ï¼‰
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
          head -c 50000 pr_diff.txt > diff_truncated.txt
          
          # èŽ·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          gh pr diff ${{ github.event.pull_request.number }} --name-only > changed_files.txt
          cat changed_files.txt

      - name: Download lint results
        uses: actions/download-artifact@v4
        with:
          name: lint-results
          path: ./artifacts
        continue-on-error: true

      - name: Download security results
        uses: actions/download-artifact@v4
        with:
          name: security-results
          path: ./artifacts
        continue-on-error: true

      - name: AI Review with DeepSeek
        id: ai-review
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          DIFF_CONTENT=$(cat diff_truncated.txt | jq -Rs .)
          
          # è¯»å– lint ç»“æžœ
          LINT_ISSUES=""
          if [ -f "./artifacts/lint-results.json" ]; then
            LINT_ISSUES=$(cat ./artifacts/lint-results.json | jq -r '.Issues[]? | "- \(.FromLinter): \(.Text) at \(.Pos.Filename):\(.Pos.Line)"' 2>/dev/null | head -20 || echo "")
          fi
          
          # è¯»å–å®‰å…¨æ‰«æç»“æžœ
          SECURITY_ISSUES=""
          if [ -f "./artifacts/security-results.json" ]; then
            SECURITY_ISSUES=$(cat ./artifacts/security-results.json | jq -r '.Issues[]? | "- [\(.Severity)] \(.Details) at \(.File):\(.Line)"' 2>/dev/null | head -10 || echo "")
          fi
          
          PROMPT="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥ä¸“å®¶ã€‚è¯·å®¡æŸ¥ä»¥ä¸‹ PR ä»£ç å˜æ›´ã€‚

          ## ä»£ç å˜æ›´ (diff):
          $DIFF_CONTENT

          ## é™æ€åˆ†æžå‘çŽ°çš„é—®é¢˜:
          $LINT_ISSUES

          ## å®‰å…¨æ‰«æå‘çŽ°çš„é—®é¢˜:
          $SECURITY_ISSUES

          è¯·è¿”å›ž JSON æ ¼å¼çš„å®¡æŸ¥ç»“æžœï¼Œç”¨äºŽåœ¨ä»£ç è¡Œä¸Šæ·»åŠ è¯„è®ºã€‚æ ¼å¼å¦‚ä¸‹ï¼š
          {
            \"summary\": \"æ€»ä½“è¯„ä»·ï¼ˆ1-2å¥è¯ï¼‰\",
            \"comments\": [
              {
                \"path\": \"æ–‡ä»¶è·¯å¾„ï¼Œå¦‚ controller/ScheduleController.go\",
                \"line\": è¡Œå·ï¼ˆå¿…é¡»æ˜¯ diff ä¸­æ–°å¢žæˆ–ä¿®æ”¹çš„è¡Œï¼Œå³ä»¥ + å¼€å¤´çš„è¡Œçš„å®žé™…è¡Œå·ï¼‰,
                \"type\": \"bug|optimization|security|suggestion\",
                \"body\": \"è¯„è®ºå†…å®¹ï¼ˆä¸­æ–‡ï¼ŒåŒ…å«é—®é¢˜æè¿°å’Œä¿®å¤å»ºè®®ï¼‰\"
              }
            ]
          }

          é‡è¦è§„åˆ™ï¼š
          1. line å¿…é¡»æ˜¯ PR diff ä¸­å®žé™…å˜æ›´çš„è¡Œå·ï¼ˆæ–°æ–‡ä»¶ä¸­çš„è¡Œå·ï¼‰
          2. path å¿…é¡»æ˜¯å®Œæ•´çš„æ–‡ä»¶è·¯å¾„
          3. æ¯ä¸ªé—®é¢˜åªè¯„è®ºä¸€æ¬¡ï¼Œæœ€å¤šè¿”å›ž 10 æ¡è¯„è®º
          4. ä¼˜å…ˆå…³æ³¨ï¼šBug > å®‰å…¨é—®é¢˜ > ä¼˜åŒ–å»ºè®®
          5. åªè¿”å›ž JSONï¼Œä¸è¦å…¶ä»–å†…å®¹"

          RESPONSE=$(curl -s https://api.deepseek.com/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
            -d "{
              \"model\": \"deepseek-chat\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"ä½ æ˜¯ä»£ç å®¡æŸ¥ä¸“å®¶ã€‚åªè¿”å›žæœ‰æ•ˆçš„ JSON æ ¼å¼ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—æˆ– markdown ä»£ç å—æ ‡è®°ã€‚\"},
                {\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}
              ],
              \"max_tokens\": 3000,
              \"temperature\": 0.1
            }")
          
          # æå– AI è¿”å›žçš„å†…å®¹
          REVIEW_JSON=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "{\"summary\": \"å®¡æŸ¥å¤±è´¥\", \"comments\": []}"')
          
          # æ¸…ç†å¯èƒ½çš„ markdown ä»£ç å—æ ‡è®°
          REVIEW_JSON=$(echo "$REVIEW_JSON" | sed 's/^```json//g' | sed 's/^```//g' | sed 's/```$//g')
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$REVIEW_JSON" > ai_review.json
          cat ai_review.json

      - name: Post inline review comments
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let reviewData;
            try {
              const rawData = fs.readFileSync('ai_review.json', 'utf8');
              reviewData = JSON.parse(rawData);
            } catch (e) {
              console.log('Failed to parse AI review JSON:', e.message);
              // å‘é€å¤±è´¥é€šçŸ¥
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âš ï¸ AI ä»£ç å®¡æŸ¥è§£æžå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ Actions æ—¥å¿—ã€‚'
              });
              return;
            }
            
            const comments = reviewData.comments || [];
            const summary = reviewData.summary || 'å®¡æŸ¥å®Œæˆ';
            
            if (comments.length === 0) {
              // æ²¡æœ‰é—®é¢˜ï¼Œå‘é€æ€»ç»“è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ðŸ¤– AI ä»£ç å®¡æŸ¥å®Œæˆ\n\nâœ… ${summary}\n\næœªå‘çŽ°éœ€è¦å…³æ³¨çš„é—®é¢˜ã€‚\n\n---\n*ç”± DeepSeek AI è‡ªåŠ¨å®¡æŸ¥*`
              });
              return;
            }
            
            // èŽ·å– PR çš„æœ€æ–° commit SHA
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // æž„å»º review comments
            const reviewComments = [];
            const typeEmoji = {
              'bug': 'ðŸ› Bug',
              'security': 'ðŸ”’ å®‰å…¨é—®é¢˜',
              'optimization': 'âš¡ ä¼˜åŒ–å»ºè®®',
              'suggestion': 'ðŸ’¡ å»ºè®®'
            };
            
            for (const comment of comments) {
              if (comment.path && comment.line && comment.body) {
                const emoji = typeEmoji[comment.type] || 'ðŸ’¬ è¯„è®º';
                reviewComments.push({
                  path: comment.path,
                  line: parseInt(comment.line),
                  body: `**${emoji}**\n\n${comment.body}`
                });
              }
            }
            
            if (reviewComments.length > 0) {
              try {
                // åˆ›å»º PR Review å¹¶æ·»åŠ è¡Œå†…è¯„è®º
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  commit_id: pr.head.sha,
                  body: `## ðŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n${summary}\n\nå…±å‘çŽ° **${reviewComments.length}** ä¸ªéœ€è¦å…³æ³¨çš„é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹çš„è¡Œå†…è¯„è®ºã€‚\n\n---\n*ç”± DeepSeek AI è‡ªåŠ¨å®¡æŸ¥ï¼Œä¿®å¤åŽå¯ç‚¹å‡» Resolve æ ‡è®°å®Œæˆ*`,
                  event: 'COMMENT',
                  comments: reviewComments
                });
                console.log(`Successfully posted ${reviewComments.length} inline comments`);
              } catch (e) {
                console.log('Failed to create review with inline comments:', e.message);
                // å¦‚æžœè¡Œå†…è¯„è®ºå¤±è´¥ï¼ˆå¯èƒ½æ˜¯è¡Œå·ä¸åœ¨ diff ä¸­ï¼‰ï¼Œé€€å›žåˆ°æ™®é€šè¯„è®º
                let fallbackBody = `## ðŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n${summary}\n\n`;
                for (const comment of comments) {
                  const emoji = typeEmoji[comment.type] || 'ðŸ’¬';
                  fallbackBody += `### ${emoji} \`${comment.path}:${comment.line}\`\n${comment.body}\n\n`;
                }
                fallbackBody += `---\n*ç”± DeepSeek AI è‡ªåŠ¨å®¡æŸ¥*`;
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: fallbackBody
                });
              }
            }

  # ç»¼åˆå®¡æŸ¥æŠ¥å‘Šï¼ˆä¸ä¾èµ– AIï¼‰
  review-report:
    name: Review Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [golangci-lint, security-scan, format-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download lint results
        uses: actions/download-artifact@v4
        with:
          name: lint-results
          path: ./artifacts
        continue-on-error: true

      - name: Download security results
        uses: actions/download-artifact@v4
        with:
          name: security-results
          path: ./artifacts
        continue-on-error: true

      - name: Generate review report
        id: report
        run: |
          echo "## ðŸ“Š ä»£ç å®¡æŸ¥æŠ¥å‘Š" > report.md
          echo "" >> report.md
          
          # èŽ·å–å˜æ›´ç»Ÿè®¡
          CHANGES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1)
          echo "### ðŸ“ å˜æ›´ç»Ÿè®¡" >> report.md
          echo "\`\`\`" >> report.md
          echo "$CHANGES" >> report.md
          echo "\`\`\`" >> report.md
          echo "" >> report.md
          
          # Lint é—®é¢˜
          echo "### ðŸ” ä»£ç è´¨é‡é—®é¢˜ (golangci-lint)" >> report.md
          if [ -f "./artifacts/lint-results.json" ]; then
            LINT_COUNT=$(cat ./artifacts/lint-results.json | jq '.Issues | length' 2>/dev/null || echo "0")
            if [ "$LINT_COUNT" != "0" ] && [ "$LINT_COUNT" != "null" ]; then
              echo "å‘çŽ° **$LINT_COUNT** ä¸ªé—®é¢˜ï¼š" >> report.md
              echo "" >> report.md
              cat ./artifacts/lint-results.json | jq -r '.Issues[]? | "| \(.Severity // "warning") | \(.FromLinter) | \(.Text) | `\(.Pos.Filename):\(.Pos.Line)` |"' 2>/dev/null | head -10 | while read line; do
                echo "$line" >> report.md
              done
              echo "" >> report.md
              # æ·»åŠ è¡¨å¤´
              sed -i '/ ä»£ç è´¨é‡é—®é¢˜/a\\n| çº§åˆ« | æ£€æŸ¥å™¨ | é—®é¢˜æè¿° | ä½ç½® |\n|------|--------|----------|------|' report.md 2>/dev/null || true
            else
              echo "âœ… æœªå‘çŽ°ä»£ç è´¨é‡é—®é¢˜" >> report.md
            fi
          else
            echo "âœ… æœªå‘çŽ°ä»£ç è´¨é‡é—®é¢˜" >> report.md
          fi
          echo "" >> report.md
          
          # å®‰å…¨é—®é¢˜
          echo "### ðŸ”’ å®‰å…¨æ‰«æ (gosec)" >> report.md
          if [ -f "./artifacts/security-results.json" ]; then
            SEC_COUNT=$(cat ./artifacts/security-results.json | jq '.Issues | length' 2>/dev/null || echo "0")
            if [ "$SEC_COUNT" != "0" ] && [ "$SEC_COUNT" != "null" ]; then
              echo "âš ï¸ å‘çŽ° **$SEC_COUNT** ä¸ªæ½œåœ¨å®‰å…¨é—®é¢˜ï¼š" >> report.md
              echo "" >> report.md
              echo "| ä¸¥é‡æ€§ | é—®é¢˜ | ä½ç½® |" >> report.md
              echo "|--------|------|------|" >> report.md
              cat ./artifacts/security-results.json | jq -r '.Issues[]? | "| \(.Severity) | \(.Details) | `\(.File):\(.Line)` |"' 2>/dev/null | head -10 >> report.md
            else
              echo "âœ… æœªå‘çŽ°å®‰å…¨é—®é¢˜" >> report.md
            fi
          else
            echo "âœ… æœªå‘çŽ°å®‰å…¨é—®é¢˜" >> report.md
          fi
          echo "" >> report.md
          
          # æ€»ç»“
          echo "---" >> report.md
          echo "" >> report.md
          echo "ðŸ’¡ **æç¤º**: å®‰è£… [CodeRabbit](https://github.com/apps/coderabbitai) å¯èŽ·å¾—æ›´è¯¦ç»†çš„ AI ä»£ç å®¡æŸ¥" >> report.md
          
          cat report.md

      - name: Post review report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
