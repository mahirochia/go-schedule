name: Code Review

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  # Go ä»£ç é™æ€åˆ†æž
  golangci-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    outputs:
      lint-result: ${{ steps.lint.outputs.result }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Run golangci-lint
        id: lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m --out-format=json
          only-new-issues: true
        continue-on-error: true

      - name: Save lint results
        if: always()
        run: |
          golangci-lint run --timeout=5m --out-format=json > lint-results.json 2>&1 || true
          
      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: lint-results.json
          retention-days: 1

  # Go å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Run Gosec Security Scanner
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -no-fail -fmt json -out security-results.json ./... 2>&1 || true

      - name: Upload security results
        uses: actions/upload-artifact@v4
        with:
          name: security-results
          path: security-results.json
          retention-days: 1

      - name: Run Gosec for SARIF
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: results.sarif

  # å‰ç«¯ä»£ç æ£€æŸ¥
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          npx eslint src --ext .vue,.js,.ts --format json > ../eslint-results.json 2>&1 || true
        continue-on-error: true

      - name: Upload ESLint results
        uses: actions/upload-artifact@v4
        with:
          name: eslint-results
          path: eslint-results.json
          retention-days: 1

  # ä»£ç æ ¼å¼æ£€æŸ¥
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Check Go formatting
        id: gofmt
        run: |
          UNFORMATTED=$(gofmt -l . 2>&1 || true)
          if [ -n "$UNFORMATTED" ]; then
            echo "unformatted=$UNFORMATTED" >> $GITHUB_OUTPUT
            echo "éœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶ï¼š"
            echo "$UNFORMATTED"
          fi

      - name: Check go mod tidy
        run: |
          go mod tidy
          if ! git diff --quiet go.mod go.sum; then
            echo "go.mod æˆ– go.sum éœ€è¦æ›´æ–°"
          fi

  # AI ä»£ç å®¡æŸ¥ï¼ˆä½¿ç”¨ DeepSeek APIï¼‰
  ai-review:
    name: AI Code Review (DeepSeek)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && vars.ENABLE_AI_REVIEW == 'true'
    needs: [golangci-lint, security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          cat changed_files.txt

      - name: Get diff content
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > diff.txt
          # é™åˆ¶ diff å¤§å°ï¼Œé¿å…è¶…å‡º API é™åˆ¶ï¼ˆDeepSeek æ”¯æŒæ›´é•¿çš„ä¸Šä¸‹æ–‡ï¼‰
          head -c 30000 diff.txt > diff_truncated.txt

      - name: Download lint results
        uses: actions/download-artifact@v4
        with:
          name: lint-results
          path: ./artifacts
        continue-on-error: true

      - name: Download security results
        uses: actions/download-artifact@v4
        with:
          name: security-results
          path: ./artifacts
        continue-on-error: true

      - name: AI Review with DeepSeek
        id: ai-review
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          DIFF_CONTENT=$(cat diff_truncated.txt | jq -Rs .)
          
          # è¯»å– lint ç»“æžœ
          LINT_ISSUES=""
          if [ -f "./artifacts/lint-results.json" ]; then
            LINT_ISSUES=$(cat ./artifacts/lint-results.json | jq -r '.Issues[]? | "- \(.FromLinter): \(.Text) at \(.Pos.Filename):\(.Pos.Line)"' 2>/dev/null | head -20 || echo "")
          fi
          
          # è¯»å–å®‰å…¨æ‰«æç»“æžœ
          SECURITY_ISSUES=""
          if [ -f "./artifacts/security-results.json" ]; then
            SECURITY_ISSUES=$(cat ./artifacts/security-results.json | jq -r '.Issues[]? | "- [\(.Severity)] \(.Details) at \(.File):\(.Line)"' 2>/dev/null | head -10 || echo "")
          fi
          
          PROMPT="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œæ“…é•¿ Go å’Œ Vue.jsã€‚è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç å˜æ›´ï¼Œç”¨ä¸­æ–‡å›žå¤ã€‚

          ## ä»£ç å˜æ›´ (diff):
          $DIFF_CONTENT

          ## é™æ€åˆ†æžå‘çŽ°çš„é—®é¢˜:
          $LINT_ISSUES

          ## å®‰å…¨æ‰«æå‘çŽ°çš„é—®é¢˜:
          $SECURITY_ISSUES

          è¯·æŒ‰ä»¥ä¸‹æ ¼å¼æä¾›å®¡æŸ¥æ„è§ï¼š

          ### ðŸ› æ½œåœ¨ Bug
          (åˆ—å‡ºå¯èƒ½çš„ bug å’Œé€»è¾‘é”™è¯¯ï¼Œå¦‚æžœæ²¡æœ‰å†™"æœªå‘çŽ°æ˜Žæ˜¾é—®é¢˜")

          ### âš¡ ä¼˜åŒ–å»ºè®®
          (åˆ—å‡ºä»£ç ä¼˜åŒ–å»ºè®®ï¼ŒåŒ…æ‹¬æ€§èƒ½ã€å¯è¯»æ€§ã€æœ€ä½³å®žè·µ)

          ### ðŸ”’ å®‰å…¨é—®é¢˜
          (åˆ—å‡ºå®‰å…¨ç›¸å…³é—®é¢˜ï¼Œå¦‚ SQL æ³¨å…¥ã€XSSã€æ•æ„Ÿä¿¡æ¯æ³„éœ²ç­‰ï¼Œå¦‚æžœæ²¡æœ‰å†™"æœªå‘çŽ°å®‰å…¨é—®é¢˜")

          ### ðŸ’¡ å…¶ä»–å»ºè®®
          (å…¶ä»–æ”¹è¿›å»ºè®®ï¼Œå¦‚ä»£ç ç»“æž„ã€å‘½åè§„èŒƒç­‰)

          è¯·ç®€æ´ä¸“ä¸šåœ°å›žå¤ï¼Œæ¯ä¸ªç±»åˆ«æœ€å¤š3æ¡æœ€é‡è¦çš„å»ºè®®ï¼Œç»™å‡ºå…·ä½“çš„ä»£ç ä½ç½®å’Œä¿®å¤æ–¹æ¡ˆã€‚"

          RESPONSE=$(curl -s https://api.deepseek.com/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
            -d "{
              \"model\": \"deepseek-chat\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œç²¾é€š Goã€Vue.jsã€å®‰å…¨æœ€ä½³å®žè·µã€‚è¯·æä¾›å…·ä½“ã€å¯æ“ä½œçš„å®¡æŸ¥æ„è§ã€‚ä¸è¦åœ¨å›žå¤ä¸­ä½¿ç”¨ä»£ç å—ï¼ˆåå¼•å·ï¼‰ï¼Œç›´æŽ¥ç”¨æ–‡å­—æè¿°ä»£ç ä¿®æ”¹å»ºè®®ã€‚\"},
                {\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}
              ],
              \"max_tokens\": 2000,
              \"temperature\": 0.1
            }")
          
          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "AI å®¡æŸ¥æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ DEEPSEEK_API_KEY æ˜¯å¦é…ç½®æ­£ç¡®"')
          
          # å°†å®¡æŸ¥ç»“æžœå†™å…¥æ–‡ä»¶ï¼ˆé¿å…æ¨¡æ¿å­—ç¬¦ä¸²é—®é¢˜ï¼‰
          echo "## ðŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š (DeepSeek)" > ai_review.md
          echo "" >> ai_review.md
          echo "$REVIEW" >> ai_review.md
          echo "" >> ai_review.md
          echo "---" >> ai_review.md
          echo "*æ­¤å®¡æŸ¥ç”± DeepSeek AI è‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚*" >> ai_review.md

      - name: Post AI review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('ai_review.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # ç»¼åˆå®¡æŸ¥æŠ¥å‘Šï¼ˆä¸ä¾èµ– AIï¼‰
  review-report:
    name: Review Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [golangci-lint, security-scan, format-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download lint results
        uses: actions/download-artifact@v4
        with:
          name: lint-results
          path: ./artifacts
        continue-on-error: true

      - name: Download security results
        uses: actions/download-artifact@v4
        with:
          name: security-results
          path: ./artifacts
        continue-on-error: true

      - name: Generate review report
        id: report
        run: |
          echo "## ðŸ“Š ä»£ç å®¡æŸ¥æŠ¥å‘Š" > report.md
          echo "" >> report.md
          
          # èŽ·å–å˜æ›´ç»Ÿè®¡
          CHANGES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1)
          echo "### ðŸ“ å˜æ›´ç»Ÿè®¡" >> report.md
          echo "\`\`\`" >> report.md
          echo "$CHANGES" >> report.md
          echo "\`\`\`" >> report.md
          echo "" >> report.md
          
          # Lint é—®é¢˜
          echo "### ðŸ” ä»£ç è´¨é‡é—®é¢˜ (golangci-lint)" >> report.md
          if [ -f "./artifacts/lint-results.json" ]; then
            LINT_COUNT=$(cat ./artifacts/lint-results.json | jq '.Issues | length' 2>/dev/null || echo "0")
            if [ "$LINT_COUNT" != "0" ] && [ "$LINT_COUNT" != "null" ]; then
              echo "å‘çŽ° **$LINT_COUNT** ä¸ªé—®é¢˜ï¼š" >> report.md
              echo "" >> report.md
              cat ./artifacts/lint-results.json | jq -r '.Issues[]? | "| \(.Severity // "warning") | \(.FromLinter) | \(.Text) | `\(.Pos.Filename):\(.Pos.Line)` |"' 2>/dev/null | head -10 | while read line; do
                echo "$line" >> report.md
              done
              echo "" >> report.md
              # æ·»åŠ è¡¨å¤´
              sed -i '/ ä»£ç è´¨é‡é—®é¢˜/a\\n| çº§åˆ« | æ£€æŸ¥å™¨ | é—®é¢˜æè¿° | ä½ç½® |\n|------|--------|----------|------|' report.md 2>/dev/null || true
            else
              echo "âœ… æœªå‘çŽ°ä»£ç è´¨é‡é—®é¢˜" >> report.md
            fi
          else
            echo "âœ… æœªå‘çŽ°ä»£ç è´¨é‡é—®é¢˜" >> report.md
          fi
          echo "" >> report.md
          
          # å®‰å…¨é—®é¢˜
          echo "### ðŸ”’ å®‰å…¨æ‰«æ (gosec)" >> report.md
          if [ -f "./artifacts/security-results.json" ]; then
            SEC_COUNT=$(cat ./artifacts/security-results.json | jq '.Issues | length' 2>/dev/null || echo "0")
            if [ "$SEC_COUNT" != "0" ] && [ "$SEC_COUNT" != "null" ]; then
              echo "âš ï¸ å‘çŽ° **$SEC_COUNT** ä¸ªæ½œåœ¨å®‰å…¨é—®é¢˜ï¼š" >> report.md
              echo "" >> report.md
              echo "| ä¸¥é‡æ€§ | é—®é¢˜ | ä½ç½® |" >> report.md
              echo "|--------|------|------|" >> report.md
              cat ./artifacts/security-results.json | jq -r '.Issues[]? | "| \(.Severity) | \(.Details) | `\(.File):\(.Line)` |"' 2>/dev/null | head -10 >> report.md
            else
              echo "âœ… æœªå‘çŽ°å®‰å…¨é—®é¢˜" >> report.md
            fi
          else
            echo "âœ… æœªå‘çŽ°å®‰å…¨é—®é¢˜" >> report.md
          fi
          echo "" >> report.md
          
          # æ€»ç»“
          echo "---" >> report.md
          echo "" >> report.md
          echo "ðŸ’¡ **æç¤º**: å®‰è£… [CodeRabbit](https://github.com/apps/coderabbitai) å¯èŽ·å¾—æ›´è¯¦ç»†çš„ AI ä»£ç å®¡æŸ¥" >> report.md
          
          cat report.md

      - name: Post review report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
