name: Code Review

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  # Go ä»£ç é™æ€åˆ†æ
  golangci-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    outputs:
      lint-result: ${{ steps.lint.outputs.result }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Run golangci-lint
        id: lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m --out-format=json
          only-new-issues: true
        continue-on-error: true

      - name: Save lint results
        if: always()
        run: |
          golangci-lint run --timeout=5m --out-format=json > lint-results.json 2>&1 || true
          
      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: lint-results.json
          retention-days: 1

  # Go å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Run Gosec Security Scanner
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -no-fail -fmt json -out security-results.json ./... 2>&1 || true

      - name: Upload security results
        uses: actions/upload-artifact@v4
        with:
          name: security-results
          path: security-results.json
          retention-days: 1

      - name: Run Gosec for SARIF
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: results.sarif

  # å‰ç«¯ä»£ç æ£€æŸ¥
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: |
          npx eslint src --ext .vue,.js,.ts --format json > ../eslint-results.json 2>&1 || true
        continue-on-error: true

      - name: Upload ESLint results
        uses: actions/upload-artifact@v4
        with:
          name: eslint-results
          path: eslint-results.json
          retention-days: 1

  # ä»£ç æ ¼å¼æ£€æŸ¥
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Check Go formatting
        id: gofmt
        run: |
          UNFORMATTED=$(gofmt -l . 2>&1 || true)
          if [ -n "$UNFORMATTED" ]; then
            echo "unformatted=$UNFORMATTED" >> $GITHUB_OUTPUT
            echo "éœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶ï¼š"
            echo "$UNFORMATTED"
          fi

      - name: Check go mod tidy
        run: |
          go mod tidy
          if ! git diff --quiet go.mod go.sum; then
            echo "go.mod æˆ– go.sum éœ€è¦æ›´æ–°"
          fi

  # AI ä»£ç å®¡æŸ¥ï¼ˆä½¿ç”¨ DeepSeek API - è¡Œå†…è¯„è®ºï¼‰
  ai-review:
    name: AI Code Review (DeepSeek)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && vars.ENABLE_AI_REVIEW == 'true'
    needs: [golangci-lint, security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff and extract changed lines
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # è·å– PR çš„ diff
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
          head -c 50000 pr_diff.txt > diff_truncated.txt
          
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          gh pr diff ${{ github.event.pull_request.number }} --name-only > changed_files.txt
          cat changed_files.txt
          
          # è§£æ diffï¼Œæå–æ¯ä¸ªæ–‡ä»¶çš„å˜æ›´è¡Œå·ï¼ˆæ–°æ–‡ä»¶ä¸­çš„è¡Œå·ï¼‰
          # è¾“å‡ºæ ¼å¼: file_path:line_number
          python3 << 'EOF' > changed_lines.json
          import re
          import json

          with open('pr_diff.txt', 'r') as f:
              diff_content = f.read()

          changed_lines = {}
          current_file = None
          new_line_num = 0

          for line in diff_content.split('\n'):
              # åŒ¹é…æ–‡ä»¶è·¯å¾„ +++ b/path/to/file
              if line.startswith('+++ b/'):
                  current_file = line[6:]
                  changed_lines[current_file] = []
              # åŒ¹é… hunk header @@ -old_start,old_count +new_start,new_count @@
              elif line.startswith('@@') and current_file:
                  match = re.search(r'\+(\d+)', line)
                  if match:
                      new_line_num = int(match.group(1))
              # æ–°å¢æˆ–ä¿®æ”¹çš„è¡Œï¼ˆä»¥ + å¼€å¤´ï¼Œä½†ä¸æ˜¯ +++ æ–‡ä»¶å¤´ï¼‰
              elif line.startswith('+') and not line.startswith('+++') and current_file:
                  changed_lines[current_file].append(new_line_num)
                  new_line_num += 1
              # ä¸Šä¸‹æ–‡è¡Œï¼ˆä¸ä»¥ + æˆ– - å¼€å¤´ï¼‰
              elif not line.startswith('-') and current_file and not line.startswith('\\'):
                  new_line_num += 1

          print(json.dumps(changed_lines, indent=2))
          EOF
          
          echo "Changed lines per file:"
          cat changed_lines.json

      - name: Download lint results
        uses: actions/download-artifact@v4
        with:
          name: lint-results
          path: ./artifacts
        continue-on-error: true

      - name: Download security results
        uses: actions/download-artifact@v4
        with:
          name: security-results
          path: ./artifacts
        continue-on-error: true

      - name: AI Review with DeepSeek
        id: ai-review
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          DIFF_CONTENT=$(cat diff_truncated.txt | jq -Rs .)
          CHANGED_LINES=$(cat changed_lines.json | jq -Rs .)
          
          # è¯»å– lint ç»“æœ
          LINT_ISSUES=""
          if [ -f "./artifacts/lint-results.json" ]; then
            LINT_ISSUES=$(cat ./artifacts/lint-results.json | jq -r '.Issues[]? | "- \(.FromLinter): \(.Text) at \(.Pos.Filename):\(.Pos.Line)"' 2>/dev/null | head -20 || echo "")
          fi
          
          # è¯»å–å®‰å…¨æ‰«æç»“æœ
          SECURITY_ISSUES=""
          if [ -f "./artifacts/security-results.json" ]; then
            SECURITY_ISSUES=$(cat ./artifacts/security-results.json | jq -r '.Issues[]? | "- [\(.Severity)] \(.Details) at \(.File):\(.Line)"' 2>/dev/null | head -10 || echo "")
          fi
          
          PROMPT="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥ä¸“å®¶ã€‚è¯·å®¡æŸ¥ä»¥ä¸‹ PR ä»£ç å˜æ›´ã€‚

          ## ä»£ç å˜æ›´ (diff):
          $DIFF_CONTENT

          ## æ¯ä¸ªæ–‡ä»¶ä¸­å®é™…å˜æ›´çš„è¡Œå·ï¼ˆåªèƒ½åœ¨è¿™äº›è¡Œä¸Šè¯„è®ºï¼‰:
          $CHANGED_LINES

          ## é™æ€åˆ†æå‘ç°çš„é—®é¢˜:
          $LINT_ISSUES

          ## å®‰å…¨æ‰«æå‘ç°çš„é—®é¢˜:
          $SECURITY_ISSUES

          è¯·è¿”å› JSON æ ¼å¼çš„å®¡æŸ¥ç»“æœã€‚æ ¼å¼å¦‚ä¸‹ï¼š
          {
            \"summary\": \"æ€»ä½“è¯„ä»·ï¼ˆ1-2å¥è¯ï¼‰\",
            \"comments\": [
              {
                \"path\": \"æ–‡ä»¶è·¯å¾„\",
                \"line\": è¡Œå·,
                \"type\": \"bug|optimization|security|suggestion\",
                \"body\": \"é—®é¢˜æè¿°å’Œä¿®å¤å»ºè®®ï¼ˆä¸­æ–‡ï¼‰\"
              }
            ]
          }

          æå…¶é‡è¦çš„è§„åˆ™ï¼š
          1. line å¿…é¡»ä»ä¸Šé¢æä¾›çš„ 'æ¯ä¸ªæ–‡ä»¶ä¸­å®é™…å˜æ›´çš„è¡Œå·' åˆ—è¡¨ä¸­é€‰æ‹©ï¼
          2. å¦‚æœå‘ç°çš„é—®é¢˜æ‰€åœ¨è¡Œä¸åœ¨å˜æ›´è¡Œåˆ—è¡¨ä¸­ï¼Œé€‰æ‹©æœ€è¿‘çš„ä¸€ä¸ªå˜æ›´è¡Œ
          3. path å¿…é¡»ä¸å˜æ›´è¡Œåˆ—è¡¨ä¸­çš„æ–‡ä»¶è·¯å¾„å®Œå…¨ä¸€è‡´
          4. æœ€å¤šè¿”å› 8 æ¡è¯„è®ºï¼Œä¼˜å…ˆå…³æ³¨ä¸¥é‡é—®é¢˜
          5. åªè¿”å›çº¯ JSONï¼Œä¸è¦ markdown æ ‡è®°"

          RESPONSE=$(curl -s https://api.deepseek.com/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
            -d "{
              \"model\": \"deepseek-chat\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"ä½ æ˜¯ä»£ç å®¡æŸ¥ä¸“å®¶ã€‚ä¸¥æ ¼æŒ‰è¦æ±‚è¿”å› JSONã€‚è¯„è®ºçš„ line å¿…é¡»æ˜¯ç”¨æˆ·æä¾›çš„å˜æ›´è¡Œåˆ—è¡¨ä¸­å­˜åœ¨çš„è¡Œå·ã€‚\"},
                {\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}
              ],
              \"max_tokens\": 3000,
              \"temperature\": 0.1
            }")
          
          # æå– AI è¿”å›çš„å†…å®¹
          REVIEW_JSON=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "{\"summary\": \"å®¡æŸ¥å¤±è´¥\", \"comments\": []}"')
          
          # æ¸…ç†å¯èƒ½çš„ markdown ä»£ç å—æ ‡è®°
          REVIEW_JSON=$(echo "$REVIEW_JSON" | sed 's/^```json//g' | sed 's/^```//g' | sed 's/```$//g' | tr -d '\n' | sed 's/^[[:space:]]*//')
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$REVIEW_JSON" > ai_review.json
          cat ai_review.json

      - name: Post inline review comments
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // è¯»å–å˜æ›´è¡Œä¿¡æ¯
            let changedLines = {};
            try {
              changedLines = JSON.parse(fs.readFileSync('changed_lines.json', 'utf8'));
              console.log('Changed lines:', JSON.stringify(changedLines, null, 2));
            } catch (e) {
              console.log('Failed to parse changed lines:', e.message);
            }
            
            let reviewData;
            try {
              const rawData = fs.readFileSync('ai_review.json', 'utf8');
              console.log('Raw AI review:', rawData);
              reviewData = JSON.parse(rawData);
            } catch (e) {
              console.log('Failed to parse AI review JSON:', e.message);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'âš ï¸ AI ä»£ç å®¡æŸ¥è§£æå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ Actions æ—¥å¿—ã€‚'
              });
              return;
            }
            
            const comments = reviewData.comments || [];
            const summary = reviewData.summary || 'å®¡æŸ¥å®Œæˆ';
            
            if (comments.length === 0) {
              // æ²¡æœ‰é—®é¢˜ï¼Œå‘é€æ€»ç»“è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ğŸ¤– AI ä»£ç å®¡æŸ¥å®Œæˆ\n\nâœ… ${summary}\n\næœªå‘ç°éœ€è¦å…³æ³¨çš„é—®é¢˜ã€‚\n\n---\n*ç”± DeepSeek AI è‡ªåŠ¨å®¡æŸ¥*`
              });
              return;
            }
            
            // è·å– PR çš„æœ€æ–° commit SHA
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // æ„å»º review commentsï¼ŒéªŒè¯è¡Œå·æœ‰æ•ˆæ€§
            const reviewComments = [];
            const skippedComments = [];
            const typeEmoji = {
              'bug': 'ğŸ› Bug',
              'security': 'ğŸ”’ å®‰å…¨é—®é¢˜',
              'optimization': 'âš¡ ä¼˜åŒ–å»ºè®®',
              'suggestion': 'ğŸ’¡ å»ºè®®'
            };
            
            // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾æœ€è¿‘çš„æœ‰æ•ˆè¡Œå·
            function findNearestValidLine(path, targetLine, changedLines) {
              const validLines = changedLines[path] || [];
              if (validLines.length === 0) return null;
              if (validLines.includes(targetLine)) return targetLine;
              
              // æ‰¾æœ€è¿‘çš„è¡Œ
              let nearest = validLines[0];
              let minDiff = Math.abs(targetLine - nearest);
              for (const line of validLines) {
                const diff = Math.abs(targetLine - line);
                if (diff < minDiff) {
                  minDiff = diff;
                  nearest = line;
                }
              }
              return nearest;
            }
            
            for (const comment of comments) {
              if (comment.path && comment.line && comment.body) {
                const emoji = typeEmoji[comment.type] || 'ğŸ’¬ è¯„è®º';
                const targetLine = parseInt(comment.line);
                
                // éªŒè¯è¡Œå·æ˜¯å¦åœ¨å˜æ›´èŒƒå›´å†…
                const validLine = findNearestValidLine(comment.path, targetLine, changedLines);
                
                if (validLine) {
                  console.log(`Comment on ${comment.path}:${targetLine} -> using line ${validLine}`);
                  reviewComments.push({
                    path: comment.path,
                    line: validLine,
                    side: 'RIGHT',
                    body: `**${emoji}**\n\n${comment.body}`
                  });
                } else {
                  console.log(`Skipping comment on ${comment.path}:${targetLine} - file not in diff`);
                  skippedComments.push(comment);
                }
              }
            }
            
            if (reviewComments.length > 0) {
              try {
                // åˆ›å»º PR Review å¹¶æ·»åŠ è¡Œå†…è¯„è®º
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  commit_id: pr.head.sha,
                  body: `## ğŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n${summary}\n\nå…±å‘ç° **${reviewComments.length}** ä¸ªéœ€è¦å…³æ³¨çš„é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹çš„è¡Œå†…è¯„è®ºã€‚\n\n---\n*ç”± DeepSeek AI è‡ªåŠ¨å®¡æŸ¥ï¼Œä¿®å¤åå¯ç‚¹å‡» Resolve æ ‡è®°å®Œæˆ*`,
                  event: 'COMMENT',
                  comments: reviewComments
                });
                console.log(`Successfully posted ${reviewComments.length} inline comments`);
              } catch (e) {
                console.log('Failed to create review with inline comments:', e.message);
                console.log('Error details:', JSON.stringify(e, null, 2));
                
                // å°è¯•é€ä¸ªæ·»åŠ è¯„è®º
                let successCount = 0;
                for (const rc of reviewComments) {
                  try {
                    await github.rest.pulls.createReviewComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_number: context.issue.number,
                      commit_id: pr.head.sha,
                      path: rc.path,
                      line: rc.line,
                      side: 'RIGHT',
                      body: rc.body
                    });
                    successCount++;
                    console.log(`Posted comment on ${rc.path}:${rc.line}`);
                  } catch (innerError) {
                    console.log(`Failed to post comment on ${rc.path}:${rc.line}:`, innerError.message);
                  }
                }
                
                if (successCount === 0) {
                  // å®Œå…¨å¤±è´¥ï¼Œé€€å›åˆ°æ™®é€šè¯„è®º
                  let fallbackBody = `## ğŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n${summary}\n\n`;
                  for (const comment of comments) {
                    const emoji = typeEmoji[comment.type] || 'ğŸ’¬';
                    fallbackBody += `### ${emoji} \`${comment.path}:${comment.line}\`\n${comment.body}\n\n`;
                  }
                  fallbackBody += `---\n*ç”± DeepSeek AI è‡ªåŠ¨å®¡æŸ¥*`;
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: fallbackBody
                  });
                } else {
                  // éƒ¨åˆ†æˆåŠŸï¼Œå‘ä¸ªæ€»ç»“
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: `## ğŸ¤– AI ä»£ç å®¡æŸ¥å®Œæˆ\n\n${summary}\n\nå·²æ·»åŠ  ${successCount} æ¡è¡Œå†…è¯„è®ºã€‚\n\n---\n*ç”± DeepSeek AI è‡ªåŠ¨å®¡æŸ¥*`
                  });
                }
              }
            } else if (skippedComments.length > 0) {
              // æ²¡æœ‰æœ‰æ•ˆçš„è¡Œå†…è¯„è®ºï¼Œä½†æœ‰è¢«è·³è¿‡çš„è¯„è®ºï¼Œç”¨æ™®é€šè¯„è®ºå±•ç¤º
              let fallbackBody = `## ğŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n${summary}\n\n`;
              for (const comment of skippedComments) {
                const emoji = typeEmoji[comment.type] || 'ğŸ’¬';
                fallbackBody += `### ${emoji} \`${comment.path}:${comment.line}\`\n${comment.body}\n\n`;
              }
              fallbackBody += `---\n*ç”± DeepSeek AI è‡ªåŠ¨å®¡æŸ¥*`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: fallbackBody
              });
            }

  # ç»¼åˆå®¡æŸ¥æŠ¥å‘Šï¼ˆä¸ä¾èµ– AIï¼‰
  review-report:
    name: Review Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [golangci-lint, security-scan, format-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download lint results
        uses: actions/download-artifact@v4
        with:
          name: lint-results
          path: ./artifacts
        continue-on-error: true

      - name: Download security results
        uses: actions/download-artifact@v4
        with:
          name: security-results
          path: ./artifacts
        continue-on-error: true

      - name: Generate review report
        id: report
        run: |
          echo "## ğŸ“Š ä»£ç å®¡æŸ¥æŠ¥å‘Š" > report.md
          echo "" >> report.md
          
          # è·å–å˜æ›´ç»Ÿè®¡
          CHANGES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1)
          echo "### ğŸ“ å˜æ›´ç»Ÿè®¡" >> report.md
          echo "\`\`\`" >> report.md
          echo "$CHANGES" >> report.md
          echo "\`\`\`" >> report.md
          echo "" >> report.md
          
          # Lint é—®é¢˜
          echo "### ğŸ” ä»£ç è´¨é‡é—®é¢˜ (golangci-lint)" >> report.md
          if [ -f "./artifacts/lint-results.json" ]; then
            LINT_COUNT=$(cat ./artifacts/lint-results.json | jq '.Issues | length' 2>/dev/null || echo "0")
            if [ "$LINT_COUNT" != "0" ] && [ "$LINT_COUNT" != "null" ]; then
              echo "å‘ç° **$LINT_COUNT** ä¸ªé—®é¢˜ï¼š" >> report.md
              echo "" >> report.md
              cat ./artifacts/lint-results.json | jq -r '.Issues[]? | "| \(.Severity // "warning") | \(.FromLinter) | \(.Text) | `\(.Pos.Filename):\(.Pos.Line)` |"' 2>/dev/null | head -10 | while read line; do
                echo "$line" >> report.md
              done
              echo "" >> report.md
              # æ·»åŠ è¡¨å¤´
              sed -i '/ ä»£ç è´¨é‡é—®é¢˜/a\\n| çº§åˆ« | æ£€æŸ¥å™¨ | é—®é¢˜æè¿° | ä½ç½® |\n|------|--------|----------|------|' report.md 2>/dev/null || true
            else
              echo "âœ… æœªå‘ç°ä»£ç è´¨é‡é—®é¢˜" >> report.md
            fi
          else
            echo "âœ… æœªå‘ç°ä»£ç è´¨é‡é—®é¢˜" >> report.md
          fi
          echo "" >> report.md
          
          # å®‰å…¨é—®é¢˜
          echo "### ğŸ”’ å®‰å…¨æ‰«æ (gosec)" >> report.md
          if [ -f "./artifacts/security-results.json" ]; then
            SEC_COUNT=$(cat ./artifacts/security-results.json | jq '.Issues | length' 2>/dev/null || echo "0")
            if [ "$SEC_COUNT" != "0" ] && [ "$SEC_COUNT" != "null" ]; then
              echo "âš ï¸ å‘ç° **$SEC_COUNT** ä¸ªæ½œåœ¨å®‰å…¨é—®é¢˜ï¼š" >> report.md
              echo "" >> report.md
              echo "| ä¸¥é‡æ€§ | é—®é¢˜ | ä½ç½® |" >> report.md
              echo "|--------|------|------|" >> report.md
              cat ./artifacts/security-results.json | jq -r '.Issues[]? | "| \(.Severity) | \(.Details) | `\(.File):\(.Line)` |"' 2>/dev/null | head -10 >> report.md
            else
              echo "âœ… æœªå‘ç°å®‰å…¨é—®é¢˜" >> report.md
            fi
          else
            echo "âœ… æœªå‘ç°å®‰å…¨é—®é¢˜" >> report.md
          fi
          echo "" >> report.md
          
          # æ€»ç»“
          echo "---" >> report.md
          echo "" >> report.md
          echo "ğŸ’¡ **æç¤º**: å®‰è£… [CodeRabbit](https://github.com/apps/coderabbitai) å¯è·å¾—æ›´è¯¦ç»†çš„ AI ä»£ç å®¡æŸ¥" >> report.md
          
          cat report.md

      - name: Post review report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
